#!/bin/bash

die(){
    >&2 echo "ccrun: ERROR: $*"
    exit 1
}

print_help(){
    while IFS= read line; do
        echo "$line"
    done <<-EOF
ccrun FILES [FLAGS] [-- PROG_FLAGS]
  Compiles and runs a c family program
    FILE       - source file to be run
    PROG_FLAGS - flags to be passed to the executable being run
    FLAGS:
      -c CC         - set compiler [default: "gcc"]
      -o OUTPUT     - set output executable file to OUTPUT [default: "\$TEMP_DIR/ccrun.out"]
      -h            - print this message
      -n, --no-run  - don't run the executable, just compile
EOF
}

cc="gcc"
files=()
no_run=0
output="$TEMP_DIR/ccrun.out"
while [[ $# > 0 ]]; do
    arg="$1"
    shift
    case "$arg" in # convert all long flags into short
        --no-run)
            arg='-n' # pass as n flag instead
            ;;
    esac
    case "$arg" in # parse all short flags
        --)
            break # the rest of the args get passed to the executable
            ;;
        --*)
            die "unexpected long flag '$arg'"
            ;;
        -)
            die "unexpected flag '-'"
            ;;
        -*)
            need_arg=0
            flags="${arg#?}" # everything but first character
            for flag in `echo "$flags" | grep -o .`; do
                [[ $need_arg == 1 ]] && die "-$flag_n_arg flag expected an argument"
                case "$flag" in
                    c|o)
                        need_arg=1
                        flag_n_arg=$flag
                        ;;
                    n)
                        no_run=1
                        ;;
                    h)
                        print_help
                        exit 0
                        ;;
                    *)
                        die "unexpected flag '$flag'"
                        ;;
                esac
            done
            flag=${arg: -1} # last character
            if [[ $need_arg == 1 ]]; then
                [[ $# > 0 ]] || die "-$flag flag expected an argument"
                case $flag in
                    c)
                        cc="$1"
                        ;;
                    o)
                        output="$1"
                        ;;
                esac
                shift
            fi
            ;;
        *)
            files+=($arg)
            ;;
    esac
done
[[ "$output" == */* ]] || output="./$output"

$cc "${files[@]}" -o "$output" && [[ $no_run == 0 ]] && "$output" "$@"
